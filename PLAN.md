# План реализации программы ChatList

## Этап 1: Подготовка проекта и структуры

### 1.1 Инициализация проекта
- [x] Создать базовую структуру PyQt приложения
- [ ] Создать структуру папок проекта
- [ ] Настроить requirements.txt с необходимыми зависимостями
- [ ] Создать .env.example файл для примера конфигурации

### 1.2 Создание модульной структуры
- [ ] Создать модуль `db.py` для работы с SQLite
- [ ] Создать модуль `models.py` для логики работы с моделями
- [ ] Создать модуль `network.py` для HTTP-запросов к API
- [ ] Создать модуль `config.py` для загрузки настроек из .env

## Этап 2: Реализация базы данных

### 2.1 Создание схемы БД
- [ ] Реализовать функцию создания таблиц в `db.py`:
  - Таблица `prompts` (id, date, prompt, tags)
  - Таблица `models` (id, name, api_url, api_id, is_active)
  - Таблица `results` (id, prompt_id, model_id, response, selected, created_at)
  - Таблица `settings` (key, value)

### 2.2 CRUD операции для таблиц
- [ ] Реализовать функции для работы с `prompts`:
  - `create_prompt(date, prompt, tags)`
  - `get_all_prompts()`
  - `get_prompt_by_id(id)`
  - `search_prompts(query)`
  - `delete_prompt(id)`

- [ ] Реализовать функции для работы с `models`:
  - `create_model(name, api_url, api_id, is_active)`
  - `get_active_models()`
  - `get_all_models()`
  - `update_model_status(id, is_active)`
  - `delete_model(id)`

- [ ] Реализовать функции для работы с `results`:
  - `save_results(results_list)`
  - `get_all_results()`
  - `get_results_by_prompt(prompt_id)`
  - `search_results(query)`
  - `delete_result(id)`

- [ ] Реализовать функции для работы с `settings`:
  - `get_setting(key)`
  - `set_setting(key, value)`

## Этап 3: Реализация работы с API

### 3.1 Модуль network.py
- [ ] Создать базовый класс для работы с API
- [ ] Реализовать загрузку API-ключей из .env файла
- [ ] Реализовать функцию отправки запроса к OpenAI API
- [ ] Реализовать функцию отправки запроса к DeepSeek API
- [ ] Реализовать функцию отправки запроса к Groq API
- [ ] Создать универсальную функцию `send_request(model, prompt)` с обработкой разных типов API
- [ ] Добавить обработку ошибок и таймаутов
- [ ] Реализовать асинхронную отправку запросов к нескольким моделям

### 3.2 Модуль models.py
- [ ] Реализовать класс Model для представления нейросети
- [ ] Реализовать функцию `get_active_models()` для получения списка активных моделей
- [ ] Реализовать функцию `send_prompt_to_models(prompt, models)` для параллельной отправки

## Этап 4: Реализация графического интерфейса

### 4.1 Основное окно (main.py)
- [ ] Создать главное окно приложения
- [ ] Реализовать меню и панель инструментов
- [ ] Разделить окно на области:
  - Левая панель: список сохраненных промтов
  - Центральная область: поле ввода промта
  - Правая панель: настройки моделей
  - Нижняя область: таблица результатов

### 4.2 Область ввода промта
- [ ] Создать текстовое поле для ввода нового промта
- [ ] Добавить кнопку "Отправить"
- [ ] Добавить выпадающий список для выбора сохраненного промта
- [ ] Добавить поле для ввода тегов
- [ ] Реализовать кнопку "Сохранить промт"

### 4.3 Таблица результатов
- [ ] Создать QTableWidget для отображения результатов
- [ ] Настроить колонки: Модель, Ответ, Выбрано (чекбокс)
- [ ] Реализовать временное хранение результатов в памяти
- [ ] Добавить кнопку "Сохранить выбранные"
- [ ] Реализовать очистку таблицы при новом запросе
- [ ] Добавить поиск и сортировку по колонкам

### 4.4 Панель управления моделями
- [ ] Создать список моделей с чекбоксами (активна/неактивна)
- [ ] Добавить кнопку "Добавить модель"
- [ ] Добавить кнопку "Редактировать модель"
- [ ] Добавить кнопку "Удалить модель"
- [ ] Реализовать диалог добавления/редактирования модели

### 4.5 Панель истории промтов
- [ ] Создать список сохраненных промтов
- [ ] Добавить поиск по промтам
- [ ] Добавить фильтрацию по тегам
- [ ] Реализовать двойной клик для выбора промта
- [ ] Добавить контекстное меню (удалить, редактировать)

## Этап 5: Интеграция компонентов

### 5.1 Связывание UI с базой данных
- [ ] Подключить загрузку промтов из БД в список
- [ ] Подключить сохранение промтов в БД
- [ ] Подключить загрузку моделей из БД
- [ ] Подключить сохранение результатов в БД

### 5.2 Связывание UI с API
- [ ] Реализовать обработчик кнопки "Отправить"
- [ ] Интегрировать отправку запросов к моделям
- [ ] Реализовать отображение результатов в таблице
- [ ] Добавить индикатор загрузки во время запросов
- [ ] Обработать ошибки при запросах к API

### 5.3 Сохранение результатов
- [ ] Реализовать обработчик кнопки "Сохранить выбранные"
- [ ] Сохранить выбранные результаты в таблицу results
- [ ] Очистить временную таблицу после сохранения

## Этап 6: Дополнительные функции

### 6.1 Поиск и сортировка
- [ ] Реализовать поиск в таблице промтов
- [ ] Реализовать поиск в таблице результатов
- [ ] Добавить сортировку по колонкам во всех таблицах

### 6.2 Экспорт данных
- [ ] Реализовать экспорт результатов в Markdown
- [ ] Реализовать экспорт результатов в JSON
- [ ] Добавить меню "Экспорт" с выбором формата

### 6.3 Логирование
- [ ] Добавить модуль логирования
- [ ] Логировать все запросы к API
- [ ] Логировать ошибки и исключения
- [ ] Добавить просмотр логов в интерфейсе

### 6.4 Настройки приложения
- [ ] Реализовать окно настроек
- [ ] Добавить настройку таймаутов запросов
- [ ] Добавить настройку путей к файлам
- [ ] Сохранять настройки в таблицу settings

## Этап 7: Тестирование и оптимизация

### 7.1 Тестирование функциональности
- [ ] Протестировать работу с базой данных
- [ ] Протестировать отправку запросов к API
- [ ] Протестировать сохранение и загрузку данных
- [ ] Протестировать UI компоненты

### 7.2 Обработка ошибок
- [ ] Добавить обработку ошибок подключения к БД
- [ ] Добавить обработку ошибок API запросов
- [ ] Добавить валидацию ввода данных
- [ ] Улучшить сообщения об ошибках для пользователя

### 7.3 Оптимизация
- [ ] Оптимизировать запросы к базе данных
- [ ] Оптимизировать загрузку данных в UI
- [ ] Добавить кэширование при необходимости

## Этап 8: Финальная доработка

### 8.1 Документация
- [ ] Написать README с инструкциями по установке
- [ ] Добавить комментарии в код
- [ ] Создать примеры использования

### 8.2 Сборка
- [ ] Обновить build.bat для финальной сборки
- [ ] Протестировать исполняемый файл
- [ ] Подготовить релиз

## Этап 9: AI-ассистент для улучшения промтов

### 9.1 Модуль для улучшения промтов (prompt_improver.py)
- [ ] Создать новый модуль `prompt_improver.py` для логики улучшения промтов
- [ ] Реализовать функцию `improve_prompt(prompt_text, model_name, api_key)`:
  - Принимает исходный текст промта
  - Отправляет запрос к указанной модели через OpenRouter API
  - Использует специальный системный промт для улучшения
  - Возвращает структурированный ответ с улучшенными вариантами
- [ ] Реализовать функцию `generate_prompt_variants(prompt_text, model_name, api_key)`:
  - Генерирует 2-3 варианта переформулировки промта
  - Возвращает список альтернативных вариантов
- [ ] Реализовать функцию `adapt_prompt_for_type(prompt_text, prompt_type, model_name, api_key)`:
  - Адаптирует промт под разные типы задач:
    - `code` - для задач программирования
    - `analysis` - для аналитических задач
    - `creative` - для креативных задач
  - Возвращает адаптированный промт

### 9.2 Системные промпты для улучшения
- [ ] Создать шаблоны системных промптов:
  - Шаблон для общего улучшения промта
  - Шаблон для генерации вариантов переформулировки
  - Шаблоны для адаптации под типы задач (code, analysis, creative)
- [ ] Реализовать функцию `build_improvement_prompt(original_prompt, task_type)`:
  - Формирует системный промт на основе типа задачи
  - Включает инструкции для AI по улучшению промта
- [ ] Реализовать парсинг ответа AI:
  - Извлечение улучшенного промта
  - Извлечение альтернативных вариантов
  - Обработка структурированного ответа (JSON/Markdown)

### 9.3 UI компоненты для улучшения промтов
- [ ] Добавить кнопку "Улучшить промт" рядом с полем ввода промта в `main.py`
- [ ] Создать диалоговое окно `PromptImprovementDialog`:
  - Отображает исходный промт (read-only)
  - Отображает улучшенный промт
  - Отображает 2-3 альтернативных варианта в виде списка/таблицы
  - Кнопки "Подставить в поле ввода" для каждого варианта
  - Кнопка "Заменить исходный" для замены текущего промта
  - Индикатор загрузки во время обработки
- [ ] Реализовать выбор модели для улучшения:
  - Выпадающий список с доступными моделями (из таблицы models)
  - По умолчанию использовать первую активную модель
  - Возможность выбрать модель специально для улучшения промтов
- [ ] Добавить опцию выбора типа адаптации:
  - Радио-кнопки или выпадающий список: "Общее улучшение", "Код", "Анализ", "Креатив"
  - Влияет на системный промт, отправляемый AI

### 9.4 Интеграция с существующим кодом
- [ ] Интегрировать `prompt_improver.py` с модулем `network.py`:
  - Использовать существующие функции отправки запросов к OpenRouter
  - Переиспользовать обработку ошибок и таймаутов
- [ ] Интегрировать с модулем `models.py`:
  - Получать список доступных моделей из БД
  - Использовать API-ключи из .env через `config.py`
- [ ] Добавить обработку ошибок:
  - Обработка ошибок API (404, 401, таймауты)
  - Валидация входного промта (не пустой, не слишком длинный)
  - Отображение понятных сообщений об ошибках пользователю
- [ ] Добавить логирование:
  - Логировать запросы на улучшение промтов
  - Логировать используемые модели и типы адаптации
  - Логировать время выполнения запросов

### 9.5 Асинхронная обработка
- [ ] Реализовать асинхронную отправку запроса на улучшение:
  - Использовать `QThread` для неблокирующей обработки
  - Показывать индикатор загрузки во время обработки
  - Разрешить отмену операции
- [ ] Реализовать класс `PromptImprovementThread(QThread)`:
  - Наследуется от `QThread`
  - Выполняет запрос к API в отдельном потоке
  - Эмитирует сигналы для обновления UI (прогресс, результат, ошибка)

### 9.6 Сохранение улучшенных промтов
- [ ] Добавить возможность сохранить улучшенный промт:
  - Кнопка "Сохранить как новый промт" в диалоге улучшения
  - Автоматическое добавление тега "улучшенный" или "improved"
  - Сохранение связи с исходным промтом (опционально, через теги)
- [ ] Реализовать историю улучшений (опционально):
  - Сохранять исходный и улучшенный промты в БД
  - Возможность просмотра истории улучшений для промта

### 9.7 Настройки улучшения промтов
- [ ] Добавить настройки в таблицу `settings`:
  - `prompt_improver_default_model` - модель по умолчанию для улучшения
  - `prompt_improver_temperature` - температура для генерации вариантов
  - `prompt_improver_max_variants` - максимальное количество вариантов (2-5)
- [ ] Реализовать окно настроек улучшения промтов:
  - Выбор модели по умолчанию
  - Настройка параметров генерации
  - Сохранение в таблицу settings

### 9.8 Тестирование и оптимизация
- [ ] Протестировать улучшение промтов с разными моделями:
  - Тестирование с бесплатными моделями OpenRouter
  - Тестирование с платными моделями
  - Проверка качества улучшений
- [ ] Протестировать обработку ошибок:
  - Недоступность модели
  - Неверный API-ключ
  - Таймауты
  - Некорректные ответы от API
- [ ] Оптимизировать системные промпты:
  - Сократить длину промптов для экономии токенов
  - Улучшить качество инструкций для AI
  - Протестировать разные формулировки
- [ ] Добавить кэширование (опционально):
  - Кэшировать результаты улучшения для одинаковых промтов
  - Сохранять в памяти или БД для быстрого доступа

